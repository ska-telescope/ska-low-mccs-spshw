{{- /*
Defines the deployment for MccsCalibrationStore Tango devices.

Currently all device properties are hardcoded except the logging level default,
so configure like this:

  deviceServers:
    calibrationstores:
      s1-2:
        low-mccs/calibrationstore/s1-2:
          logging_level_default: 5

*/}}
{{- if (hasKey .Values "deviceServers")}}
{{- $namespace := .Release.Namespace}}
{{- $calibration_stores := dig "calibrationstores" dict .Values.deviceServers}}
{{- if $calibration_stores}}
name: calibrationstore-{{.Release.Name}}
function: ska-low-mccs-spshw-calibrationstore-tango
domain: ska-low-mccs-spshw
instances:
{{- range $server_key := keys $calibration_stores}}
  - {{printf "calibrationstore-%s" $server_key}}
{{- end}}
command: MccsCalibrationStore
server:
  name: "MccsCalibrationStore"
  instances:
{{- range $server_key, $this_server := $calibration_stores}}
    - name: {{printf "calibrationstore-%s" $server_key}}
      classes:
        - name: "MccsCalibrationStore"
          devices:
{{- range $calibration_store_name, $this_calibration_store := $this_server}}
            - name: {{$calibration_store_name}}
              properties:
                - name: "DatabaseHost"
                  values:
                    - "station-calibration-postgresql"
                - name: "DatabasePort"
                  values:
                    - "5432"
                - name: "DatabaseName"
                  values:
                    - "postgres"
                - name: "DatabaseAdminUser"
                  values:
                    - "postgres"
                - name: "DatabaseAdminPassword"
                  values:
                    - "secretpassword"
{{- with $this_calibration_store.logging_level_default}}
                - name: "LoggingLevelDefault"
                  values:
                    - {{quote .}}
{{- end}}
{{- end}}
{{- end}}
depends_on:
  - device: sys/database/2
image:
{{- with .Values.image}}
  registry: {{.registry | quote}}
  image: {{.name | quote}}
  tag: {{.tag | default $.Chart.AppVersion | quote}}
  pullPolicy: {{.pullPolicy | quote}}
{{- end}}
livenessProbe:
{{ toYaml .Values.livenessProbe | indent 2 }}
readinessProbe:
{{ toYaml .Values.readinessProbe | indent 2 }}
{{- end}}
{{- end}}
