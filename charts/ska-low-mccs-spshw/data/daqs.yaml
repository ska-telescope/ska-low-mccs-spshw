{{- $release := .Release}}
{{- $values := .Values}}
{{- range $id, $spec := .Values.receivers }}
{{- $station_id := (int $id)}}
{{- $defaults := dict
  "host" (printf "daq-simulator-%03d" $station_id)
  "port" 50051
  "receiver_interface" "eth0"
  "receiver_ip" ""
  "receiver_port" 4660
  "logging_level_default" 3
}}
{{- $defaulted := (mergeOverwrite $defaults $spec)}}
name: daq-receiver-{{$release.Name}}
function: ska-low-mccs-daq-daqreceiver
domain: ska-low-mccs-daq
instances:
  - {{(printf "daq-tango-%03d" $station_id) | quote}}
command: "MccsDaqReceiver"
server:
  name: "MccsDaqReceiver"
  instances:
    - name: {{(printf "daq-tango-%03d" $station_id) | quote}}
      classes:
      - name: "MccsDaqReceiver"
        devices:
        - name: {{(printf "low-mccs/daqreceiver/%03d" $station_id) | quote}}
          properties:
          - name: "DaqId"
            values:
            - {{$station_id | toString | quote}}
          - name: "ReceiverInterface"
            values:
            - {{$defaulted.receiver_interface | quote}}
          - name: "ReceiverIp"
            values:
            - {{$defaulted.receiver_ip | quote}}
          - name: "ReceiverPort"
            values:
            - {{$defaulted.receiver_port | toString | quote}}
          - name: "Host"
            values:
            - {{$defaulted.host | quote}}
          - name: "Port"
            values:
            - {{$defaulted.port | toString | quote}}
          - name: "ConsumersToStart"
            values:
            - "DaqModes.INTEGRATED_CHANNEL_DATA"
          - name: "LoggingLevelDefault"
            values: 
            - {{$defaulted.logging_level_default | toString | quote}}
depends_on:
  - device: sys/database/2
image:
{{- with $values.image}}
  registry: "{{.registry}}"
  image: "{{.name}}"
  tag: "{{.tag}}"
  pullPolicy: "{{.pullPolicy}}"
{{- end}}
livenessProbe:
{{toYaml $values.livenessProbe | indent 2 }}
readinessProbe:
{{toYaml $values.readinessProbe | indent 2 }}
{{- end }}
