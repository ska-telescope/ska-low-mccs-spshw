{{- /*
Defines the deployment for SpsStation Tango devices.

  deviceServers:
    spsstations:
      s8-1:
        low-mccs/spsstation/s8-1:
          station_id: 345
          station_network_address: 10.0.0.128
          antenna_config_uri:
          - "car:ska-low-aavs3?main"
          - "instrument/mccs-configuration/aavs3.yaml"
          - "a1"
          subracks:
          - "s8-1-1"
          tpms:
          - "s8-1-10"
          - "s8-1-13"
          logging_level_default: 5

*/}}
{{- $spsstations := dig "spsstations" dict .Values.deviceServers}}
{{- if $spsstations}}
name: "spsstation-{{.Release.Name}}"
function: ska-low-mccs-spshw-spsstation
domain: ska-low-mccs-spshw
instances:
{{- range $server_key := keys $spsstations}}
  - {{printf "spsstation-%s" $server_key}}
{{- end}}
command: SpsStation
server:
  name: "SpsStation"
  instances:
{{- range $server_key, $this_server := $spsstations}}
    - name: {{printf "spsstation-%s" $server_key}}
      classes:
        - name: "SpsStation"
          devices:
{{- range $spsstation_name, $this_spsstation := $this_server}}
            - name: {{$spsstation_name}}
              properties:
                - name: "StationId"
                  values:
                    - {{quote $this_spsstation.station_id}}
                - name: "AntennaConfigURI"
                  values:
{{- toYaml $this_spsstation.antenna_config_uri | nindent 20}}
                - name: "StationNetworkAddress"
                  values:
                    - {{quote $this_spsstation.station_network_address}}
{{- with $this_spsstation.daq_trl}}
                - name: "DaqTRL"
                  values:
                    - {{quote .}}
{{- end}}
                - name: "SubrackFQDNs"
                  values:
{{- range $subrack := $this_spsstation.subracks}}
                    - {{printf "low-mccs/subrack/%s" $subrack}}
{{- end}}
                - name: "TileFQDNs"
                  values:
{{- range $tpm := $this_spsstation.tpms}}
                    - {{printf "low-mccs/tile/%s" $tpm}}
{{- end}}
{{- with $this_spsstation.logging_level_default}}
                - name: "LoggingLevelDefault"
                  values:
                    - {{quote .}}
{{- end}}
{{- end}}
{{- end}}
depends_on:
  - device: sys/database/2
image:
{{- with .Values.image}}
  registry: {{.registry | quote}}
  image: {{.name | quote}}
  tag: {{.tag | default $.Chart.AppVersion | quote}}
  pullPolicy: {{.pullPolicy | quote}}
{{- end}}
livenessProbe:
{{ toYaml .Values.livenessProbe | indent 2 }}
readinessProbe:
{{ toYaml .Values.readinessProbe | indent 2 }}
{{- end}}
