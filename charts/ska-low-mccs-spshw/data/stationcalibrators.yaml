{{- /*
Defines the deployment for station calibrator Tango devices.

  deviceServers:
    stationcalibrators:
      "s1-2":
        logging_level_default: 5
        field_station_trl: "low-mccs/fieldstation/s1-2"
        calibration_store_trl: "low-mccs/calibrationstore/s1-2"

*/}}
{{- if (hasKey .Values "deviceServers")}}
{{- $station_calibrators := dig "stationcalibrators" dict .Values.deviceServers}}
{{- if $station_calibrators}}
name: "stationcalibrator-{{.Release.Name}}"
function: ska-low-mccs-spshw-stationcalibrator-tango
domain: ska-low-mccs-spshw
instances:
{{- range $id := (keys $station_calibrators)}}
  - {{printf "stationcalibrator-%s" $id}}
{{- end}}
command: MccsStationCalibrator
server:
  name: "MccsStationCalibrator"
  instances:
{{- range $id, $this_calibrator := $station_calibrators}}
    - name: {{printf "stationcalibrator-%s" $id}}
      classes:
        - name: "MccsStationCalibrator"
          devices:
            - name: {{printf "low-mccs/stationcalibrator/%s" $id}}
              properties:
                - name: "FieldStationName"
                  values:
                    - {{quote $this_calibrator.field_station_trl}}
                - name: "CalibrationStoreName"
                  values:
                    - {{quote $this_calibrator.calibration_store_trl}}
{{- with $this_calibrator.logging_level_default}}
                - name: "LoggingLevelDefault"
                  values:
                    - {{quote .}}
{{- end}}
{{- end}}
depends_on:
  - device: sys/database/2
image:
{{- with .Values.image}}
  registry: {{.registry | quote}}
  image: {{.name | quote}}
  tag: {{.tag | coalesce $.Chart.AppVersion | quote}}
  pullPolicy: {{.pullPolicy | quote}}
{{- end}}
livenessProbe:
{{ toYaml .Values.livenessProbe | indent 2 }}
readinessProbe:
{{ toYaml .Values.readinessProbe | indent 2 }}
{{- end}}
{{- end}}
