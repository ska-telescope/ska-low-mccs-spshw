{{- $tiles := .Values.deviceServers.tpms}}
name: "tile-{{.Release.Name}}"
function: ska-low-mccs-spshw-tile
domain: ska-low-mccs-spshw
instances:
{{- range $key, $this_tile := $tiles.instances}}
# https://github.com/helm/helm/issues/3308#issuecomment-585349501
{{- $raw_enabled := pluck "enabled" $this_tile $tiles | first}}
{{- if or $raw_enabled (eq ($raw_enabled | toString) "<nil>")}}
  - {{printf "tile-%04d" (int $key)}}
{{- end}}
{{- end}}
command: MccsTile
server: 
  name: "MccsTile"
  instances:
{{- range $key, $this_tile := $tiles.instances}}
    - name: {{printf "tile-%04d" (int $key)}}
      classes:
      - name: "MccsTile"
        devices:
        - name: {{printf "low-mccs/tile/%04d" (int $key)}}
          properties:
          - name: "TileId"
            values:
            - {{$key | toString | quote}}
          - name: "SubrackFQDN"
            values:
            - {{printf "low-mccs/subrack/%04d" (int $this_tile.subrack)}}
          - name: "SubrackBay"
            values:
            - {{$this_tile.subrack_bay | toString | quote}}
          - name: "AntennasPerTile"
            values:
            - "16"
          - name: "LoggingLevelDefault"
            values:
            - {{pluck "logging_level_default" $this_tile $tiles | first | default 3 | toString | quote}}
          - name: "TpmIp"
            values:
            - {{$this_tile.host | quote}}
          - name: "TpmCpldPort"
            values:
            - {{pluck "port" $this_tile $tiles | first | default 10000 | toString | quote}}
          - name: "TpmVersion"
            values:
            - {{pluck "version" $this_tile $tiles | first | quote | default "tpm_v1_6"}}
          - name: "SimulationConfig"
            values:
            - {{pluck "simulation_config" $this_tile $tiles | first | default 0 | toString | quote}}
          - name: "TestConfig"
            values:
            - {{pluck "test_config" $this_tile $tiles | first | default 0 | toString | quote}}
{{- end}}
depends_on:
  - device: sys/database/2
image:
{{- with .Values.low_mccs_spshw.image}}
  registry: {{.registry | quote}}
  image: {{.image | quote}}
  tag: {{.tag | quote}}
  pullPolicy: {{.pullPolicy | quote}}
{{- end}}
livenessProbe:
{{ toYaml .Values.livenessProbe | indent 2 }}
readinessProbe:
{{ toYaml .Values.readinessProbe | indent 2 }}
{{- if (hasKey $tiles "reachable_from") }}
nodeSelector:
  kubernetes.io/hostname: {{ $tiles.reachable_from }}
{{- end}}
